<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Admin-Редактирование отзывов</title>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="../socket.io/socket.io.js"></script>
	<script src="../_js/socket.io-file-client.js"></script>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	<link rel="stylesheet" href="../_css/bulma.css">
	<style>
		.panel-block.active{
			background-color: #ccc;
		}
		.input.redactable-input, .textarea.redactable-input{
			outline: none;
			border: none;
			box-shadow: none;
			border-bottom: 1px solid #ccc;
			border-radius: 0px;
		}
	</style>
</head>
<body><div id="app">
	<section class="section">
		<div class="container">
			<div class="columns">
				<div class="column is-5">
					<nav class="panel">
						<p class="panel-heading">
							<a>Отзывы</a>&nbsp/&nbsp
							<a class="has-text-black" href="./projects"> Проекты</a>&nbsp/&nbsp
							<a class="has-text-black" href="./chat">Диалоги</a>
						</p>
						<div v-for="(comment,index) in comments" class="panel-block">
							<a @click="readComment(index)">{{comment.author}}</a>
						</div>
						<div class="panel-block">
							<button class="button  is-fullwidth" v-on:click.prevent="showForm()">{{addCommentButtonText}}</button>
						</div>
					</nav>
				</div>
				<div class="column is-7" v-show="isSelected">
					<button class="delete" style="float: right" @click=deleteComment(index)></button>
					<form>
						<div class="file has-name">
							<label class="file-label">
								<input type="file" class="file-input" @change="updateAvatar" id="avaChange">
								<span class="file-cta">
								<div class="media-left">
									<figure class="image is-48x48">
										<img :src="curComment.avatar" alt="Placeholder image">
									</figure>
								</div>
							</span>	
						</label>
						</div>
						<div class="field">
							<input class="input redactable-input" type="text" @change="updateComment" v-model="curComment.author">
						</div>
						<div class="field">
							<input class="input redactable-input" type="text" @change="updateComment" v-model="curComment.header" >
						</div>
						<div class="field"><textarea  v-model="curComment.content" @change="updateComment" class="textarea redactable-input"></textarea>
						</div><span v-show="updateSuccess" class="icon is-large">Изменено <i class="fas fa-check-circle"></i></span>
					</form>
				</div>
			</div>
		</div>
	</section>
	<section v-show="addCommentForm">
		<div class="container">
			<form @submit.prevent="createComment()">
				<div class="field">
					<div class="control">
						<input type="text" class="input" v-model="newComment.author" placeholder="Автор">
					</div>
				</div>
				<div class="field">
					<div class="control">
						<input type="text" class="input" v-model="newComment.header" placeholder="Заголовок">
					</div>
				</div>
				<div class="field">
					<div class="control">
						<input type="text" class="input" v-model="newComment.date" placeholder="Дата отзыва">
					</div>
				</div>
				<div class="field">
					<div class="control">
						<textarea cols="30" rows="10" class="textarea" @keypress.enter.prevent="createComment()" v-model="newComment.content" placeholder="Текст отзыва"></textarea>	
					</div>
				</div>

				<div class="field">
					<div class="file has-name">
						<label class="file-label">
							<input class="file-input" type="file" name="newAva" id="newAva" v-on:change="setAvatar">
							<span class="file-cta">
								<span class="file-icon">
									<i class="fas fa-upload"></i>
								</span>
								<span class="file-label">
									Выбери файл
								</span>
							</span>
							<span class="file-name">
								{{uploadAvatarHint}}
							</span>
						</label>
					</div>
				</div>
				<div class="field">
					<div class="button is-link  is-fullwidth" @click="createComment">Вперед</div>
				</div>
			</form>
		</div>
	</section>
</div>
<script type="text/javascript">
	var app=new Vue(
		{el:'#app',
		data:{
			newComment: {
				author:'',
				content:'',
				header:'',
				date:'',
				avatar:''
			},
			comments:[],
			addCommentForm:false,
			addCommentButtonText:"Добавить",
			uploadAvatarHint:'PNG, JPG',
			curComment:0,
			isNewCommentImage:false,
			isSelected:false,
			updateSuccess:false
		},
		methods:{
			showForm:function(){
				this.addCommentForm=!this.addCommentForm;
				this.addCommentButtonText= this.addCommentButtonText=="Добавить" ? "Отмена":"Добавить";
			},
			setAvatar:function(event){
				this.newComment.avatar = '../comments/avatars/'+ event.target.files[0].name;
				this.uploadAvatarHint=event.target.files[0].name;
				console.log(this.avatar);
			},
			updateAvatar:function(event){
				var fileInput = document.querySelector('#avaChange');
				uploader.upload(fileInput.files);
				fileInput.files=[];
				this.isNewCommentImage=false;
			},
			createComment:function(){
				if (this.newComment.avatar!=='' && this.newComment.author!=='' && this.newComment.content!=='' && this.newComment.header!=='' && this.newComment.date!='')
				{
					var fileInput = document.querySelector('#newAva');
					console.log(fileInput);
					uploader.upload(fileInput.files);
					this.isNewCommentImage=true;
				}
				else {
					console.log('error!');
				}
			},
			deleteComment:function(index){
				socket.emit('deleteComment', this.curComment);
			},
			updateComment:function(){
				socket.emit('updateComment', this.curComment);
			},
			readComment:function(index){
				this.comments[index].avatar='../'+this.comments[index].avatar;
				this.curComment=this.comments[index];

				this.isSelected=true;
			},
		},
		created:()=>{
			socket=io();
			uploader= new SocketIOFileClient(socket);
		},
		mounted:()=>{
			socket.emit('getComments');
			socket.on('commentsReady', (comments)=>{
				if (comments)
					app.comments=comments;
			})

			socket.on('commentCreated',()=>{socket.emit('getComments')});
			socket.on('commentDeleted',()=>{
				app.curComment=0;
				app.isSelected=false;
				socket.emit('getComments')});
			socket.on('commentUpdated',()=>{
				app.updateSuccess=true;

			})

			uploader.on('ready', function() {
				console.log('SocketIOFile ready to go!');
			});
			uploader.on('loadstart', function() {
				console.log('Loading file to browser before sending...');
			});
			uploader.on('progress', function(progress) {
				console.log('Loaded ' + progress.loaded + ' / ' + progress.total);
			});
			uploader.on('start', function(fileInfo) {
				console.log('Start uploading', fileInfo);
			});
			uploader.on('stream', function(fileInfo) {
				console.log('Streaming... sent ' + fileInfo.sent + ' bytes.');
			});
			uploader.on('complete', function(fileInfo) {
				console.log('Upload Complete', fileInfo);
				if (app.isNewCommentImage==true){
					socket.emit('createComment', app.newComment);
					app.isNewCommentImage=false;
					for (let key in app.newComment)
					{
						app.newComment[key]='';
					}
				}
				else {
					app.curComment.avatar='../comments/avatars/'+fileInfo.originalFileName;
					socket.emit('updateComment',app.curComment);
				}
			});
			uploader.on('error', function(err) {
				console.log('Error!', err);
			});
			uploader.on('abort', function(fileInfo) {
				console.log('Aborted: ', fileInfo);
			});	
		}
	})
</script>
</body>